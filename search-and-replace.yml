# search-and-replace.yml

# Package name for namespacing (used in {package_name} placeholder)
package_name: wagtail_dsfr

apps:
  - blog
  - events
  - forms
  - content_manager
  - config
  - proconnect
  - dashboard

# Named scopes (rules can reference these by name)
scopes:
  migrations: "**/migrations/**"
  templates: "**/templates/**"
  all: "**/*"

# File extensions considered "text" (configurable)
text_extensions:
  - .py
  - .html
  - .htm
  - .txt
  - .md
  - .csv
  - .json
  - .yaml
  - .yml
  - .po
  - .ini
  - .cfg
  - .rst
  - .xml
  - .js
  - .ts
  - .css
  - .scss

# Rules. Each rule may use:
#  - scope: reference to a named scope (scopes.<name>)
#  - path_glob: an explicit git ls-files pattern (overrides scope if present)
#  - literal: true -> do a literal string replace (no regex)
#  - search & replace are strings
rules:
  # ---------- Apps configuration ----------
  # Transform app name in AppConfig classes
  - search: '(    name = ")({app})(")'
    replace: '\1{package_name}.\2\3\n    label = "{package_name}_\2"'
    path_glob: "**/apps.py"

  # ---------- Generic patterns (expanded per app) ----------
  - search: 'to="{app}\.'
    replace: 'to="{package_name}_{app}.'
    scope: migrations

  - search: 'through="{app}\.'
    replace: 'through="{package_name}_{app}.'
    scope: migrations

  - search: 'app_name="{app}'
    replace: 'app_name="{package_name}_{app}'
    scope: migrations

  - search: 'apps\.get_model\(\"{app}\"'
    replace: 'apps.get_model("{package_name}_{app}"'
    scope: migrations

  - search: '\"{app}"'
    replace: '"{package_name}_{app}"'
    filter: 'replaces = \[(.*?)\]'
    scope: migrations

  - search: '\"{app}"'
    replace: '"{package_name}_{app}"'
    filter: 'dependencies = \[(.*?)\]'
    scope: migrations

  - search: '"page_type": \["{app}'
    replace: '"page_type": ["{package_name}_{app}'
    scope: migrations

  - search: 'from {app}\.'
    replace: "from {package_name}.{app}."
    scope: all

  - search: "from {app} import"
    replace: "from {package_name}.{app} import"
    scope: all

  - search: 'include\("{app}\.'
    replace: 'include("{package_name}.{app}.'
    scope: all

  - search: 'template="{app}/'
    replace: 'template="{package_name}_{app}/'
    scope: all

  - search: 'include\ "{app}/'
    replace: 'include "{package_name}_{app}/'
    scope: templates

  - search: 'template = \("{app}'
    replace: 'template = ("{package_name}_{app}'
    scope: all

  - search: 'template = "{app}/'
    replace: 'template = "{package_name}_{app}/'
    scope: all

  - search: 'template_name = "{app}/'
    replace: 'template_name = "{package_name}_{app}/'
    scope: all

  - search: '"template": "{app}/'
    replace: '"template": "{package_name}_{app}/'
    scope: all

  - search: '\ settings.{app}'
    replace: " settings.{package_name}_{app}"
    scope: all

  - search: '"{app}\.blocks'
    replace: '"{package_name}.{app}.blocks'
    scope: migrations

  - search: "import {app}"
    replace: "import {package_name}.{app}"
    scope: migrations

  # ---------- Special-case overrides ----------
  - search: 'content_manager\.models\.MonospaceField'
    replace: "{package_name}.content_manager.models.MonospaceField"
    scope: migrations

  - search: " content_manager.blocks.IconPickerBlock"
    replace: " {package_name}.content_manager.blocks.IconPickerBlock"
    scope: migrations
    literal: true

  - search: '"content_manager.utils.'
    replace: '"{package_name}.content_manager.utils.'
    scope: all
    literal: true

  - search: "content_manager.models.{package_name}.content_manager"
    replace: "{package_name}_content_manager.models.{package_name}.content_manager"
    scope: all
    literal: true

  - search: '"blog.Person"'
    replace: '"{package_name}_blog.Person"'
    scope: all
    literal: true

  - search: '"blog.Category"'
    replace: '"{package_name}_blog.Category"'
    scope: all
    literal: true

  - search: '"blog.Organization"'
    replace: '"{package_name}_blog.Organization"'
    scope: all
    literal: true

  - search: '"blog.BlogEntryPage"'
    replace: '"{package_name}_blog.BlogEntryPage"'
    scope: all
    literal: true

  - search: '"blog.BlogIndexPage"'
    replace: '"{package_name}_blog.BlogIndexPage"'
    scope: all
    literal: true

  - search: '"events.EventEntryPage"'
    replace: '"{package_name}_events.EventEntryPage"'
    scope: all
    literal: true

  - search: '"events.EventsIndexPage"'
    replace: '"{package_name}_events.EventsIndexPage"'
    scope: all
    literal: true

  - search: '"content_manager.MegaMenu'
    replace: '"{package_name}_content_manager.MegaMenu'
    path_glob: "**/models.py"
    literal: true

  - search: '"content_manager.ContentPage"'
    replace: '"{package_name}_content_manager.ContentPage"'
    scope: all
    literal: true

  - search: '"content_manager.Tag"'
    replace: '"{package_name}_content_manager.Tag"'
    scope: all
    literal: true

  # ---------- DynamicStreamField transformations ----------
  # Step 1: Replace imports of STREAMFIELD_COMMON_BLOCKS and HERO_STREAMFIELD_BLOCKS with callable imports
  - search: 'from {package_name}\.content_manager\.blocks\.core import HERO_STREAMFIELD_BLOCKS, STREAMFIELD_COMMON_BLOCKS'
    replace: 'from {package_name}.content_manager.blocks.streamfield_callables import (\n    get_common_streamfield_blocks,\n    get_hero_streamfield_blocks,\n)'
    path_glob: "**/models.py"

  - search: 'from {package_name}\.content_manager\.blocks\.core import HERO_STREAMFIELD_BLOCKS, STREAMFIELD_COMMON_BLOCKS'
    replace: 'from {package_name}.content_manager.blocks.streamfield_callables import (\n    get_common_streamfield_blocks,\n    get_hero_streamfield_blocks,\n)'
    path_glob: "**/abstract.py"

  - search: 'from {package_name}\.content_manager\.blocks\.core import STREAMFIELD_COMMON_BLOCKS, HERO_STREAMFIELD_BLOCKS'
    replace: 'from {package_name}.content_manager.blocks.streamfield_callables import (\n    get_common_streamfield_blocks,\n    get_hero_streamfield_blocks,\n)'
    path_glob: "**/models.py"

  - search: 'from {package_name}\.content_manager\.blocks\.core import STREAMFIELD_COMMON_BLOCKS, HERO_STREAMFIELD_BLOCKS'
    replace: 'from {package_name}.content_manager.blocks.streamfield_callables import (\n    get_common_streamfield_blocks,\n    get_hero_streamfield_blocks,\n)'
    path_glob: "**/abstract.py"

  # Step 2: Add DynamicStreamField import after wagtail.fields import
  - search: 'from wagtail\.fields import (.*?)StreamField'
    replace: 'from wagtail.fields import \1StreamField\nfrom {package_name}.content_manager.fields import DynamicStreamField'
    path_glob: "**/models.py"

  - search: 'from wagtail\.fields import (.*?)StreamField'
    replace: 'from wagtail.fields import \1StreamField\nfrom {package_name}.content_manager.fields import DynamicStreamField'
    path_glob: "**/abstract.py"

  # Step 3: Replace body = StreamField(STREAMFIELD_COMMON_BLOCKS, with DynamicStreamField and callable
  - search: '(body\s*=\s*)StreamField\(\s*\n?\s*STREAMFIELD_COMMON_BLOCKS,'
    replace: '\1DynamicStreamField(\n        get_common_streamfield_blocks,'
    path_glob: "**/models.py"

  - search: '(body\s*=\s*)StreamField\(\s*\n?\s*STREAMFIELD_COMMON_BLOCKS,'
    replace: '\1DynamicStreamField(\n        get_common_streamfield_blocks,'
    path_glob: "**/abstract.py"

  # Step 4: Replace hero = StreamField(HERO_STREAMFIELD_BLOCKS, with DynamicStreamField and callable
  - search: '(hero\s*=\s*)StreamField\(\s*\n?\s*HERO_STREAMFIELD_BLOCKS,'
    replace: '\1DynamicStreamField(\n        get_hero_streamfield_blocks,'
    path_glob: "**/models.py"

  - search: '(hero\s*=\s*)StreamField\(\s*\n?\s*HERO_STREAMFIELD_BLOCKS,'
    replace: '\1DynamicStreamField(\n        get_hero_streamfield_blocks,'
    path_glob: "**/abstract.py"
